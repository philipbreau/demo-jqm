---
id: geotrack
layout: demo
title: GeoTrack
---
<div id="geotrack" title="Locate It" class="panel" onfocus="geoTrackVisible();">
    <script>
        $(document).on("pageshow", "#geotrack", function () {
            geoTrackVisible();
        });
    </script>
    <h2>GeoTrack Location Tracking</h2>
    <fieldset class="desc">
        <div class="row">
            <p class="normalText">
                Press the 'Start Tracking' button and have BridgeIt track your location. After tracking 
                has started, you can continue with other activities and come back to see your track. 
            </p>
        </div>
        <div class="row">
{% highlight javascript %}
bridgeit.geoTrack('myId', callback, options);
{% endhighlight %}
        </div>
    </fieldset>
    
    <a id="startTrackingBtn" type="button" class="btn"
        onclick="bridgeit.geoTrack('tracker','onAfterTrackingStarted', {postURL: window.echoHub + 'echoput/geotrack-' + bridgeit.getId(), parameters: {strategy:'continuous',duration:0.3,_jguid:bridgeit.getId()}});">Start Tracking</a>
    <a id="stopTrackingBtn" type="button" class="btn" style="display: none"
        onclick="bridgeit.geoTrack('tracker','onAfterTrackingStopped', {postURL: window.echoHub + 'echoput/geotrack-' + bridgeit.getId(), parameters: {strategy:'stop',_jguid:bridgeit.getId()}});">
        Stop Tracking
        <i class="icon-gear icon-spin geotracking"></i>
    </a>

    <h4>Location Updates</h4>
    <div id="geoTrackPushUpdates" class="geotrack-updates">
        <table id="geoTrackPushUpdatesHdr" class="hdr">
            <thead>
                <th>Time</th><th>Latitude</th><th>Longitude</th>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div class="data">
            <table id="geoTrackPushUpdatesTbl">
                <tbody>

                </tbody>
            </table>
        </div>
    </div>

    <div id="trackMapCanvas" style="height:200px"></div>
    <div id="trackMapOverlay" >
        <span id="trackMapDetail" style="background-color:white"></span>
    </div>
    <script type="text/javascript">
    window.geoTracking = false;
    
    bridgeit.usePushService( window.pushHub, window.apiKey);

    function onReceiveGeoTrackPush(){
        console.log("geotrack Push received");
        updateMarkers();
    }
    bridgeit.addPushListener("geotrack-" + bridgeit.getId(), "onReceiveGeoTrackPush");

    function addLocationUpdateRow(geojson){
        if( location ){
            var updatesTbl = document.getElementById('geoTrackPushUpdatesTbl');
            var updateRow = updatesTbl.insertRow(0);
            
            var timeCell = updateRow.insertCell(0);
            if( geojson.properties && geojson.properties.time ){
                var time = new Date(geojson.properties.time);
                var hrs = time.getHours();
                if( hrs <  10){ hrs = '0'+hrs}
                var mins = time.getMinutes();
                if( mins < 10){ mins = '0'+mins}
                var secs = time.getSeconds();
                if( secs < 10){ secs = '0'+secs}
                console.log('geotrack location time: ' + time);
                timeCell.innerHTML = '<span>' + hrs + ':' + mins + ':' + secs + '</span>';
            }
            
            console.log('geoTrack addLocationUpdateRow coordinates: ' + JSON.stringify(geojson));

            var latCell = updateRow.insertCell(1);
            latCell.innerHTML = '<span>' + geojson.geometry.coordinates[1] + '</span>';

            var lngCell = updateRow.insertCell(2);
            lngCell.innerHTML = '<span>' + geojson.geometry.coordinates[0] + '</span>'
        }
    }

    function onAfterTrackingStarted()  {
        console.log('geoTrack onAfterTrackingStarted');
        document.getElementById('startTrackingBtn').style.display = 'none';
        document.getElementById('stopTrackingBtn').style.display = '';
    }

    function onAfterTrackingStopped(){
        console.log('geoTrack onAfterTrackingStopped');
        document.getElementById('startTrackingBtn').style.display = '';
        document.getElementById('stopTrackingBtn').style.display = 'none';   
    }

    function geoTrackVisible()  {
        initTrackMap();
        setTimeout( function(){
            google.maps.event.trigger(geoTrackMap, 'resize');
            updateMarkers();
        },1000);
    }

    var geoTrackMap;
    var geoTrackMapMarkers = [];

    function initTrackMap() {
        console.log('geoTrack initTrackMap');
        if( !window.geoTracking ){
            window.geoTracking = true;
            var mapOptions = {
                center: new google.maps.LatLng(-34.397, 150.644),
                maxZoom: 20,
                zoom: 8,
                draggable: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            geoTrackMap = new google.maps.Map(document
                    .getElementById('trackMapCanvas'), mapOptions);
            var overlay = document.getElementById('trackMapOverlay');
            geoTrackMap.controls[google.maps.ControlPosition.RIGHT_TOP]
                    .push(overlay);
        }
    }

    function updateMarkers()  {
        console.log('geoTrack updateMarkers');
        ajaxGet(window.echoHub + 'echofetch/geotrack-' + bridgeit.getId(), processMarkers);
    }

    function processMarkers(data)  {
        console.log('geoTrack processMarkers: data='+ data);
        if (data){
            var markerData = JSON.parse(data);
            var len = markerData.length;
            var markersPlaced = false;
            for (var i = 0; i < len; i++) {
                //google maps follows english usage LatLang
                //rather than standard x,y coordinate longitude,latitude
                var coordinates = markerData[i].geometry.coordinates;
                var location = new google.maps.LatLng(
                        coordinates[1], coordinates[0]);
                addLocationUpdateRow(markerData[i]);
                var markerColor = "#" + 
                        markerData[i].properties.jguid.substring(0,6);

                //check if provided marker is too close to existing marker
                var existLen = geoTrackMapMarkers.length;
                var minDistance = 100;
                for (var j = 0; j < existLen; j++)  {
                    var distance = google.maps.geometry.spherical
                            .computeDistanceBetween (location, 
                            geoTrackMapMarkers[j].position);
                    if (distance < minDistance)  {
                        minDistance = distance;
                    }
                }
                if (minDistance < 5)  {
                    continue;
                }

                markersPlaced = true;
                var marker = new google.maps.Marker({
                    position: location,
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        strokeColor: markerColor,
                        scale: 3
                    },
                    map: geoTrackMap
                });
                geoTrackMapMarkers.push(marker);
                document.getElementById("trackMapDetail").innerHTML =
                    coordinates[0].toFixed(2) + "," +
                    coordinates[1].toFixed(2) + " " +
                    coordinates[2].toFixed(2) + "m  ";
            }
            if (markersPlaced)  {
                var existLen = geoTrackMapMarkers.length;
                var bounds = new google.maps.LatLngBounds();
                for (var j = 0; j < existLen; j++)  {
                    bounds.extend(geoTrackMapMarkers[j].position);
                }
                geoTrackMap.fitBounds(bounds);
                //zoom out a bit if only one marker
                if( existLen == 1 ){
                    geoTrackMap.setZoom(10);
                }
            }
            
        }
        else{
            console.log('no data for geotrack...')
        }
    }

    </script>
</div>
